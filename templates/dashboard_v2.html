<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¯è‚¡æœŸæƒå¤§å•ç›‘æ§ç³»ç»Ÿ V2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #666;
        }

        .status-value {
            font-weight: bold;
            color: #2c3e50;
        }

        .status-connected {
            color: #27ae60;
        }

        .status-disconnected {
            color: #e74c3c;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .controls h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-group label {
            color: #666;
            font-weight: 500;
        }

        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .data-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .data-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .option-call {
            color: #27ae60;
            font-weight: bold;
        }

        .option-put {
            color: #e74c3c;
            font-weight: bold;
        }

        .moneyness-itm {
            background-color: #d5f4e6;
            color: #27ae60;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .moneyness-atm {
            background-color: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .moneyness-otm {
            background-color: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .risk-low {
            color: #27ae60;
        }

        .risk-medium {
            color: #f39c12;
        }

        .risk-high {
            color: #e74c3c;
        }

        .direction-buy {
            color: #e74c3c;
            font-weight: bold;
        }

        .direction-sell {
            color: #27ae60;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            background-color: #d5f4e6;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .control-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 8px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ æ¸¯è‚¡æœŸæƒå¤§å•ç›‘æ§ç³»ç»Ÿ V2.0</h1>
            <p style="text-align: center; color: #666; margin-top: 10px;">
                å®æ—¶ç›‘æ§æ¸¯è‚¡æœŸæƒå¤§å•äº¤æ˜“ï¼Œæ™ºèƒ½åˆ†ææœŸæƒæ•°æ®
            </p>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="status-grid" id="statusGrid">
            <div class="status-card">
                <h3>ğŸ“¡ APIè¿æ¥çŠ¶æ€</h3>
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ“Š æ•°æ®åº“ç»Ÿè®¡</h3>
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ“ˆ ç›‘æ§è‚¡ç¥¨</h3>
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="status-card">
                <h3>â° ç³»ç»Ÿæ—¶é—´</h3>
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <h3>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h3>
            <div class="control-group">
                <label>æ—¶é—´èŒƒå›´:</label>
                <select id="timeRange">
                    <option value="1">æœ€è¿‘1å°æ—¶</option>
                    <option value="6">æœ€è¿‘6å°æ—¶</option>
                    <option value="24" selected>æœ€è¿‘24å°æ—¶</option>
                    <option value="72">æœ€è¿‘3å¤©</option>
                    <option value="168">æœ€è¿‘7å¤©</option>
                </select>
                
                <label>è‚¡ç¥¨ç­›é€‰:</label>
                <select id="stockFilter">
                    <option value="">å…¨éƒ¨è‚¡ç¥¨</option>
                </select>
                
                <button class="btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
            </div>
        </div>

        <!-- å¤§å•äº¤æ˜“ -->
        <div class="data-section">
            <h3>ğŸ”¥ å¤§å•æœŸæƒäº¤æ˜“</h3>
            <div id="bigTradesContainer">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- è‚¡ç¥¨æŠ¥ä»· -->
        <div class="data-section">
            <h3>ğŸ’¹ å®æ—¶è‚¡ç¥¨æŠ¥ä»·</h3>
            <div id="stockQuotesContainer">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Â© 2024 æ¸¯è‚¡æœŸæƒå¤§å•ç›‘æ§ç³»ç»Ÿ V2.0 | æ•°æ®æ¥æº: å¯Œé€”OpenD API</p>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let refreshInterval;
        let currentData = {
            status: null,
            bigTrades: [],
            stockQuotes: {}
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            startAutoRefresh();
        });

        // åŠ è½½åˆå§‹æ•°æ®
        async function loadInitialData() {
            await Promise.all([
                loadStatus(),
                loadBigTrades(),
                loadStockQuotes()
            ]);
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadStatus();
                loadBigTrades();
                loadStockQuotes();
            }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
        }

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.success) {
                    currentData.status = data;
                    renderStatus(data);
                    updateStockFilter(data.monitor_stocks);
                } else {
                    showError('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“ç³»ç»ŸçŠ¶æ€
        function renderStatus(data) {
            const statusGrid = document.getElementById('statusGrid');
            
            statusGrid.innerHTML = `
                <div class="status-card">
                    <h3>ğŸ“¡ APIè¿æ¥çŠ¶æ€</h3>
                    <div class="status-item">
                        <span class="status-label">è¿æ¥çŠ¶æ€:</span>
                        <span class="status-value ${data.api_status.connected ? 'status-connected' : 'status-disconnected'}">
                            ${data.api_status.connected ? 'å·²è¿æ¥' : 'Webæ¨¡å¼'}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">è®¢é˜…è‚¡ç¥¨:</span>
                        <span class="status-value">${data.api_status.subscribed_stocks || 0}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">è®¢é˜…æœŸæƒ:</span>
                        <span class="status-value">${data.api_status.subscribed_options || 0}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ç¼“å­˜æŠ¥ä»·:</span>
                        <span class="status-value">${data.api_status.cached_quotes || 0}</span>
                    </div>
                </div>
                
                <div class="status-card">
                    <h3>ğŸ“Š æ•°æ®åº“ç»Ÿè®¡</h3>
                    <div class="status-item">
                        <span class="status-label">æ€»è®°å½•æ•°:</span>
                        <span class="status-value">${data.database_stats.total_records || 0}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å¤§å•äº¤æ˜“:</span>
                        <span class="status-value">${data.database_stats.big_trades || 0}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ç›‘æ§è‚¡ç¥¨:</span>
                        <span class="status-value">${data.database_stats.unique_stocks || 0}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">æœŸæƒå“ç§:</span>
                        <span class="status-value">${data.database_stats.unique_options || 0}</span>
                    </div>
                </div>
                
                <div class="status-card">
                    <h3>ğŸ“ˆ ç›‘æ§è‚¡ç¥¨</h3>
                    ${data.monitor_stocks.map(stock => `
                        <div class="status-item">
                            <span class="status-label">${stock}</span>
                            <span class="status-value">ç›‘æ§ä¸­</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="status-card">
                    <h3>â° ç³»ç»Ÿæ—¶é—´</h3>
                    <div class="status-item">
                        <span class="status-label">å½“å‰æ—¶é—´:</span>
                        <span class="status-value">${new Date(data.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">è¿è¡ŒçŠ¶æ€:</span>
                        <span class="status-value status-connected">æ­£å¸¸è¿è¡Œ</span>
                    </div>
                </div>
            `;
        }

        // æ›´æ–°è‚¡ç¥¨ç­›é€‰å™¨
        function updateStockFilter(stocks) {
            const stockFilter = document.getElementById('stockFilter');
            const currentValue = stockFilter.value;
            
            stockFilter.innerHTML = '<option value="">å…¨éƒ¨è‚¡ç¥¨</option>';
            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock;
                option.textContent = stock;
                stockFilter.appendChild(option);
            });
            
            stockFilter.value = currentValue;
        }

        // åŠ è½½å¤§å•äº¤æ˜“
        async function loadBigTrades() {
            try {
                const hours = document.getElementById('timeRange').value;
                const stockCodes = document.getElementById('stockFilter').value;
                
                let url = `/api/big_trades?hours=${hours}`;
                if (stockCodes) {
                    url += `&stock_codes=${stockCodes}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    currentData.bigTrades = data.trades;
                    renderBigTrades(data.trades);
                } else {
                    showError('åŠ è½½å¤§å•äº¤æ˜“å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('åŠ è½½å¤§å•äº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“å¤§å•äº¤æ˜“
        function renderBigTrades(trades) {
            const container = document.getElementById('bigTradesContainer');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— å¤§å•äº¤æ˜“æ•°æ®</div>';
                return;
            }
            
            const tableHtml = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>è‚¡ç¥¨</th>
                                <th>æœŸæƒä»£ç </th>
                                <th>ç±»å‹</th>
                                <th>æ‰§è¡Œä»·</th>
                                <th>æœŸæƒä»·æ ¼</th>
                                <th>æˆäº¤é‡</th>
                                <th>æˆäº¤é¢</th>
                                <th>æ–¹å‘</th>
                                <th>ä»·å€¼çŠ¶æ€</th>
                                <th>é£é™©ç­‰çº§</th>
                                <th>é‡è¦æ€§</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${trades.map(trade => `
                                <tr>
                                    <td>${trade.time || ''}</td>
                                    <td>
                                        <div>${trade.stock_code}</div>
                                        <div style="font-size: 0.8em; color: #666;">${trade.stock_name}</div>
                                    </td>
                                    <td style="font-size: 0.8em;">${trade.option_code}</td>
                                    <td class="${trade.option_type === 'Call' ? 'option-call' : 'option-put'}">
                                        ${trade.option_type}
                                    </td>
                                    <td>${trade.strike_price}</td>
                                    <td>${trade.option_price}</td>
                                    <td>${trade.volume}</td>
                                    <td>${formatNumber(trade.turnover)}</td>
                                    <td class="${trade.direction === 'BUY' ? 'direction-buy' : 'direction-sell'}">
                                        ${trade.direction}
                                    </td>
                                    <td>
                                        <span class="moneyness-${trade.moneyness ? trade.moneyness.toLowerCase() : 'unknown'}">
                                            ${trade.moneyness || 'Unknown'}
                                        </span>
                                    </td>
                                    <td class="risk-${trade.risk_level ? trade.risk_level.toLowerCase() : 'unknown'}">
                                        ${trade.risk_level || 'Unknown'}
                                    </td>
                                    <td>${trade.importance_score || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }

        // åŠ è½½è‚¡ç¥¨æŠ¥ä»·
        async function loadStockQuotes() {
            try {
                const response = await fetch('/api/stock_quotes');
                const data = await response.json();
                
                if (data.success) {
                    currentData.stockQuotes = data.quotes;
                    renderStockQuotes(data.quotes);
                } else {
                    showError('åŠ è½½è‚¡ç¥¨æŠ¥ä»·å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                showError('åŠ è½½è‚¡ç¥¨æŠ¥ä»·å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“è‚¡ç¥¨æŠ¥ä»·
        function renderStockQuotes(quotes) {
            const container = document.getElementById('stockQuotesContainer');
            
            if (!quotes || Object.keys(quotes).length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— è‚¡ç¥¨æŠ¥ä»·æ•°æ®</div>';
                return;
            }
            
            const tableHtml = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>è‚¡ç¥¨ä»£ç </th>
                                <th>è‚¡ç¥¨åç§°</th>
                                <th>æœ€æ–°ä»·æ ¼</th>
                                <th>æ¶¨è·Œå¹…</th>
                                <th>æˆäº¤é‡</th>
                                <th>æˆäº¤é¢</th>
                                <th>æ›´æ–°æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.values(quotes).map(quote => `
                                <tr>
                                    <td>${quote.code}</td>
                                    <td>${quote.name}</td>
                                    <td>${quote.price}</td>
                                    <td class="${quote.change_rate >= 0 ? 'status-connected' : 'status-disconnected'}">
                                        ${quote.change_rate >= 0 ? '+' : ''}${(quote.change_rate * 100).toFixed(2)}%
                                    </td>
                                    <td>${formatNumber(quote.volume)}</td>
                                    <td>${formatNumber(quote.turnover)}</td>
                                    <td>${new Date(quote.update_time).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadInitialData();
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7); // é»˜è®¤å¯¼å‡ºæœ€è¿‘7å¤©
            const endDate = new Date();
            
            const url = `/api/export?start_date=${startDate.toISOString()}&end_date=${endDate.toISOString()}&format=csv`;
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.href = url;
            link.download = `options_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            console.error(message);
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¥½çš„é”™è¯¯æ˜¾ç¤ºé€»è¾‘
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>